<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>coreJS-app</title>
    <meta name="description" content="coreJS App Documentation" />
    <meta name="keywords" content="corejs-app" />
    <meta name="keyword" content="corejs-app" />
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    <meta property="og:site_name" content=""/>
    <meta property="og:url" content=""/>
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"coreJS-app","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"coreJS-app","description":"coreJS App Documentation","keyword":"corejs-app"}};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">coreJS-app</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="app">
            <span class="title">
                <a href="app.html">app</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="app.root"><a href="app.html#root">root</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.jst">
            <span class="title">
                <a href="app.jst.html">app.jst</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.oauth">
            <span class="title">
                <a href="app.oauth.html">app.oauth</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="app.oauth.URL_ENCODED"><a href="app.oauth.html#URL_ENCODED">URL_ENCODED</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="app.oauth.authorization"><a href="app.oauth.html#authorization">authorization</a></li>
            
                <li data-name="app.oauth.token"><a href="app.oauth.html#token">token</a></li>
            
                <li data-name="app.oauth.user"><a href="app.oauth.html#user">user</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.services">
            <span class="title">
                <a href="app.services.html">app.services</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="app.services.arrayScopesToString"><a href="app.services.html#arrayScopesToString">arrayScopesToString</a></li>
            
                <li data-name="app.services.isCrossDomain"><a href="app.services.html#isCrossDomain">isCrossDomain</a></li>
            
                <li data-name="app.services.request"><a href="app.services.html#request">request</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.services.method">
            <span class="title">
                <a href="app.services.method.html">app.services.method</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="app.services.method.DELETE"><a href="app.services.method.html#DELETE">DELETE</a></li>
            
                <li data-name="app.services.method.GET"><a href="app.services.method.html#GET">GET</a></li>
            
                <li data-name="app.services.method.HEAD"><a href="app.services.method.html#HEAD">HEAD</a></li>
            
                <li data-name="app.services.method.OPTIONS"><a href="app.services.method.html#OPTIONS">OPTIONS</a></li>
            
                <li data-name="app.services.method.PATCH"><a href="app.services.method.html#PATCH">PATCH</a></li>
            
                <li data-name="app.services.method.POST"><a href="app.services.method.html#POST">POST</a></li>
            
                <li data-name="app.services.method.PUT"><a href="app.services.method.html#PUT">PUT</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.session">
            <span class="title">
                <a href="app.session.html">app.session</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="app.session.STATUS_SELECTOR"><a href="app.session.html#STATUS_SELECTOR">STATUS_SELECTOR</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="app.session.add"><a href="app.session.html#add">add</a></li>
            
                <li data-name="app.session.destroy"><a href="app.session.html#destroy">destroy</a></li>
            
                <li data-name="app.session.exist"><a href="app.session.html#exist">exist</a></li>
            
                <li data-name="app.session.gatekeeper"><a href="app.session.html#gatekeeper">gatekeeper</a></li>
            
                <li data-name="app.session.get"><a href="app.session.html#get">get</a></li>
            
                <li data-name="app.session.isPersistent"><a href="app.session.html#isPersistent">isPersistent</a></li>
            
                <li data-name="app.session.logged"><a href="app.session.html#logged">logged</a></li>
            
                <li data-name="app.session.removeStatus"><a href="app.session.html#removeStatus">removeStatus</a></li>
            
                <li data-name="app.session.setPersistent"><a href="app.session.html#setPersistent">setPersistent</a></li>
            
                <li data-name="app.session.setStatus"><a href="app.session.html#setStatus">setStatus</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.user">
            <span class="title">
                <a href="app.user.html">app.user</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="app.user.login"><a href="app.user.html#login">login</a></li>
            
                <li data-name="app.user.loginToken"><a href="app.user.html#loginToken">loginToken</a></li>
            
                <li data-name="app.user.logout"><a href="app.user.html#logout">logout</a></li>
            
                <li data-name="app.user.register"><a href="app.user.html#register">register</a></li>
            
                <li data-name="app.user.registerIAM"><a href="app.user.html#registerIAM">registerIAM</a></li>
            
                <li data-name="app.user.remove"><a href="app.user.html#remove">remove</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.user.statusCode">
            <span class="title">
                <a href="app.user.statusCode.html">app.user.statusCode</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="app.user.statusCode.USER_EXIST"><a href="app.user.statusCode.html#USER_EXIST">USER_EXIST</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="services.js_.html">Source: engine/services.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source"><code>'use strict';
/* global define */
define([
    'corejs/app',
    'jquery',
    'underscore',
    'q'
], function(
    app,
    $,
    _,
    q
) {

    /** 
     * A module to make async requests.
     * @exports services
     * @namespace
     * @memberof app
     */
    var services = {

        /**
         * method constants
         * @namespace
         */
        method: {

            /**
             * GET constant
             * @type {String}
             * @default GET
             */
            GET: 'GET',
            /**
             * @type {String}
             * @default POST
             */
            POST: 'POST',
            /**
             * @type {String}
             * @default PUT
             */
            PUT: 'PUT',
            /**
             * @type {String}
             * @default DELETE
             */
            DELETE: 'DELETE',
            /**
             * @type {String}
             * @default OPTIONS
             */
            OPTIONS: 'OPTIONS',
            /**
             * @type {String}
             * @default PATCH
             */
            PATCH: 'PATCH',
            /**
             * @type {String}
             * @default HEAD
             */
            HEAD: 'HEAD'
        }
    };

    /**
     * Check if an url should be process as a crossdomain resource.
     * @return {Boolean}
     */
    services.isCrossDomain = function(url) {
        if (url && url.indexOf('http') !== -1) {
            return true;
        } else {
            return false;
        }
    };

    /**
     * Generic Services request.
     * Support all $.ajax parameters and some more:
     * More info: https://api.jquery.com/jQuery.ajax/
     * @param {Object} args
     * @param {String} [args.method=app.services.method.GET]
     * @param {String} [args.accessToken] set request with auth. (Incopatible with args.withAuth)
     * @param {Boolean} [args.withAuth] set request with auth. (Incopatible with args.accessToken)
     * @return {Deferred}
     */
    services.request = function(args) {
        // TODO: use q promise
        var dfd = $.Deferred();

        var secure = args.accessToken || args.withAuth;
        if (secure) {
            // Get access token from arguments or app sesssion 
            args.accessToken = args.accessToken || app.session.get('accessToken');
            if (!args.accessToken) {
                //No matter if we successed on getting the access token we execute the call
                requestAccessToken().then(function(data) {
                    args.accessToken = data.accessToken;
                    doRequestCall(dfd, args, false);
                });
            } else {
                doRequestCall(dfd, args, true);
            }
        } else {
            doRequestCall(dfd, args, false);
        }
        return dfd.promise();
    };

    /**
     * Transform an array of scopes to a string separated by an space
     * @param  {Array} scopes
     * @return {String}
     */
    services.arrayScopesToString = function(scopes) {
        return _.reduce(scopes, function(memo, scope) {
            return memo + ' ' + scope;
        }, '').substr(1);
    };

    /**
     * Execute the actual ajax request.
     *
     * @param  {Deferred} dfd     The deferred object to resolve when the ajax request is completed.
     * @param  {Object} args    The request arguments.
     * @param  {Boolean} doRetry Wether to try the request when unauthorized.
     */
    var doRequestCall = function(dfd, args, doRetry) {
        var params = buildParams(args);

        $.ajax(params).then(function() {
            dfd.resolve.apply(this, arguments);
        }).fail(function(jqXHR) {
            if (jqXHR.status === 401 && doRetry) {
                retry(params, dfd);
            } else {
                // Any other error fail to the caller
                dfd.reject.apply(this, arguments);
            }
        });
    };

    /**
     * Returns a valid $.ajax parameters with default values,
     * CORS detection and authorization params if needed.
     * By default, all request are json (dataType/contentType)
     * with object serialization support
     * @param  {Object} args
     * @return {Object}
     */
    var buildParams = function(args) {

        // Default values
        args = args || {};
        args.dataType = args.dataType || 'json';
        args.contentType = args.contentType || 'application/json; charset=utf-8';
        args.dataFilter = args.dataFilter || addEmptyJson;

        // Construct url with query string
        var url = args.url;
        if (args.query) {
            url += '?' + args.query;
        }

        var headers = args.headers || {};
        // Use access access token if exists
        if (args.accessToken) {
            headers.Authorization = 'Bearer ' + args.accessToken;
        }
        if (args.Accept) {
            headers.Accept = args.Accept;
            args.dataType = undefined;  // Accept y dataType son incompatibles
        }
        var params = {
            url: url,
            dataType: args.dataType,
            contentType: args.contentType,
            type: args.method || services.method.GET,
            headers: headers,
            data: (args.contentType.indexOf('json') !== -1 && typeof args.data === 'object' ? JSON.stringify(args.data) : args.data),
            dataFilter: args.dataFilter
        };

        if (services.isCrossDomain(url)) {
            // http://stackoverflow.com/questions/5241088/jquery-call-to-webservice-returns-no-transport-error
            $.support.cors = true;
            params.crossDomain = true;
        }

        app.log.debug('services.request (params)', params);
        if (args.data) {
            app.log.debug('services.request (data)', args.data);
        }

        return params;
    };

    var addEmptyJson = function(response, type) {
        if (!response && type === 'json') {
            response = '{}';
        }
        return response;
    };

    /**
     * Try to update the accessToken to retry the same ajax request defined by params
     * @private
     * @memberOf app.services
     * @param  {object} params  An $.ajax specific parameters
     * @param  {Deferred} promise The promise to resolve/reject
     * @return {Deferred}         The same promise of parameters to add more callbacks
     */
    var retry = function(params, promise) {
        requestAccessToken().then(function(data) {
            // Use the new token
            params.headers.Authorization = 'Bearer ' + data.accessToken;
            $.ajax(params).then(function() {
                promise.resolve.apply(this, arguments);
            }, function() {
                promise.reject.apply(this, arguments);
            });
        }).fail(function() {
            promise.reject.apply(this, arguments);
        });
    };

    /**
     * Try to request an accessToken
     * @return {Deferred}
     */
    var requestAccessToken = function() {
        /**
         * Request a handler for token:fail
         * @name token:fail
         * @event
         */
        var accessTokenRequest = app.reqres.request('token:fail');
        if (accessTokenRequest) {
            return accessTokenRequest;
        } else {
            app.log.warn('No handler for token:fail event. Application must refresh the access token manually');
            var dfd = q.defer();
            dfd.reject('No handler for token:fail event. Application must refresh the access token manually');
            return dfd.promise;
        }
    };

    // Expose module
    app.services = services;

    return services;

});</code></pre>
        </article>
    </section>





        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Fri Apr 04 2014 18:45:54 GMT+0200 (CEST)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>