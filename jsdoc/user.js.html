<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>coreJS-app</title>
    <meta name="description" content="coreJS App Documentation" />
    <meta name="keywords" content="corejs-app" />
    <meta name="keyword" content="corejs-app" />
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    <meta property="og:site_name" content=""/>
    <meta property="og:url" content=""/>
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"coreJS-app","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"coreJS-app","description":"coreJS App Documentation","keyword":"corejs-app"}};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">coreJS-app</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="app">
            <span class="title">
                <a href="app.html">app</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="app.root"><a href="app.html#root">root</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.jst">
            <span class="title">
                <a href="app.jst.html">app.jst</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.oauth">
            <span class="title">
                <a href="app.oauth.html">app.oauth</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="app.oauth.URL_ENCODED"><a href="app.oauth.html#URL_ENCODED">URL_ENCODED</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="app.oauth.authorization"><a href="app.oauth.html#authorization">authorization</a></li>
            
                <li data-name="app.oauth.token"><a href="app.oauth.html#token">token</a></li>
            
                <li data-name="app.oauth.user"><a href="app.oauth.html#user">user</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.services">
            <span class="title">
                <a href="app.services.html">app.services</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="app.services.arrayScopesToString"><a href="app.services.html#arrayScopesToString">arrayScopesToString</a></li>
            
                <li data-name="app.services.isCrossDomain"><a href="app.services.html#isCrossDomain">isCrossDomain</a></li>
            
                <li data-name="app.services.request"><a href="app.services.html#request">request</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.services.method">
            <span class="title">
                <a href="app.services.method.html">app.services.method</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="app.services.method.DELETE"><a href="app.services.method.html#DELETE">DELETE</a></li>
            
                <li data-name="app.services.method.GET"><a href="app.services.method.html#GET">GET</a></li>
            
                <li data-name="app.services.method.HEAD"><a href="app.services.method.html#HEAD">HEAD</a></li>
            
                <li data-name="app.services.method.OPTIONS"><a href="app.services.method.html#OPTIONS">OPTIONS</a></li>
            
                <li data-name="app.services.method.PATCH"><a href="app.services.method.html#PATCH">PATCH</a></li>
            
                <li data-name="app.services.method.POST"><a href="app.services.method.html#POST">POST</a></li>
            
                <li data-name="app.services.method.PUT"><a href="app.services.method.html#PUT">PUT</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.session">
            <span class="title">
                <a href="app.session.html">app.session</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="app.session.STATUS_SELECTOR"><a href="app.session.html#STATUS_SELECTOR">STATUS_SELECTOR</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="app.session.add"><a href="app.session.html#add">add</a></li>
            
                <li data-name="app.session.destroy"><a href="app.session.html#destroy">destroy</a></li>
            
                <li data-name="app.session.exist"><a href="app.session.html#exist">exist</a></li>
            
                <li data-name="app.session.gatekeeper"><a href="app.session.html#gatekeeper">gatekeeper</a></li>
            
                <li data-name="app.session.get"><a href="app.session.html#get">get</a></li>
            
                <li data-name="app.session.isPersistent"><a href="app.session.html#isPersistent">isPersistent</a></li>
            
                <li data-name="app.session.logged"><a href="app.session.html#logged">logged</a></li>
            
                <li data-name="app.session.removeStatus"><a href="app.session.html#removeStatus">removeStatus</a></li>
            
                <li data-name="app.session.setPersistent"><a href="app.session.html#setPersistent">setPersistent</a></li>
            
                <li data-name="app.session.setStatus"><a href="app.session.html#setStatus">setStatus</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.user">
            <span class="title">
                <a href="app.user.html">app.user</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="app.user.login"><a href="app.user.html#login">login</a></li>
            
                <li data-name="app.user.loginToken"><a href="app.user.html#loginToken">loginToken</a></li>
            
                <li data-name="app.user.logout"><a href="app.user.html#logout">logout</a></li>
            
                <li data-name="app.user.register"><a href="app.user.html#register">register</a></li>
            
                <li data-name="app.user.registerIAM"><a href="app.user.html#registerIAM">registerIAM</a></li>
            
                <li data-name="app.user.remove"><a href="app.user.html#remove">remove</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="app.user.statusCode">
            <span class="title">
                <a href="app.user.statusCode.html">app.user.statusCode</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="app.user.statusCode.USER_EXIST"><a href="app.user.statusCode.html#USER_EXIST">USER_EXIST</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="user.js.html">Source: engine/user.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source"><code>'use strict';
/* global define */
define([
    'corejs/app',
    'jquery',
    'underscore',
    'q',
    'corejs/engine/session',
    'corejs/engine/silkroad/oauth',
    'corejs/engine/silkroad/iam',
    'corejs/engine/validate',

    // supported oauthServices
    'corejs/engine/oauthServices/oauthServer'

], function(app, $, _, q, session, oauth, iam, validate) {

    
    /** 
     * A module to manage users
     * @exports user
     * @namespace
     * @memberof app
     */
    var user = {

        /**
         * HTTP status codes constants
         * @namespace
         */
        statusCode: {

            /**
             * USER_EXIST constant
             * @type {String}
             * @default 409
             */
            USER_EXIST: 409
        }
    };

    /**
     * Autenticates users
     * @param  {Object} args
     * @param  {Object} args.oauthService Name of the oauth service ('silkroad', 'facebook', 'google', ...)
     * @param  {Object} args.username For silkroad-oauthServer-based users
     * @param  {Object} args.password For silkroad-oauthServer-based users
     * @param  {Object} args.remember For persistent login
     * @return {Deferred} Promise that resolves with an user object
     */
    user.login = function(args) {
        validate.isValue(args.oauthService, 'missing oauthService params');

        /**
         * Requests a handler for login in a specific oauthServer
         * @param  {Object} args
         * @param  {Object} args.oauthService Name of the oauth service ('silkroad', 'facebook', 'google', ...)
         * @return {Deferred}
         * @name oauth:service:login:[oauthServer]
         * @event
         */
        return app.reqres.request('oauth:service:login:' + args.oauthService, args)
        .then(function(data) {
            app.vent.trigger('user:login');
            app.log.debug('user.oauth.data', data);

            args.accessToken = data.accessToken;

            return user.loginToken(args);
        });
    };

    /**
     * Generates a user session with a valid user accessToken
     * @param  {Object} args
     * @param  {Object} args.oauthService Name of the oauth service ('silkroad', 'facebook', 'google', ...)
     * @param  {Object} args.accessToken Valid user accessToken
     * @param  {Object} args.remember For persistent login
     * @return {Deferred} Promise that resolves with an user object
     */
    user.loginToken = function(args) {
        session.logged({
            persistent: args.remember,
            accessToken: args.accessToken,
            oauthService: args.oauthService,
            user: {}
        });

        return iam.user().getMe()
        .then(function(data) {
            session.logged({
                persistent: args.remember,
                accessToken: args.accessToken,
                oauthService: args.oauthService,
                user: data
            });
            return data;
        }).fail(function(error) {
            app.log.error('user:login:iam:fail', error);
            app.vent.trigger('user:iam:fail',error);
            app.log.info('login:fail');
            var dfd = q.defer();
            dfd.reject(error);
            return dfd.promise;
        });
    };

    /**
     * Triggers a system logout
     * @return {Deferred} Returns Deferred for more user consistency
     */
    user.logout = function() {
        var dfd = q.defer();
        app.vent.trigger('user:logout');
        app.log.debug('user.logout: ', 'oauth:service:logout:' + session.get('oauthService'));
        /**
         * Request a handler for logout in a specific oauthServer
         * @name oauth:service:logout:[oauthServer]
         * @event
         */
        app.vent.trigger('oauth:service:logout:' + session.get('oauthService'));
        session.destroy();
        dfd.resolve();
        return dfd.promise;
    };

    user.me = function(oauthService) {
        validate.isValue(oauthService, 'missing oauthService params');
        var dfd = q.defer();

        /**
         * Requests a handler for request logged user data from a specific oauthServer
         * @param  {Object} args
         * @param  {Object} args.oauthService Name of the oauth service ('silkroad', 'facebook', 'google', ...)
         * @return {Deferred}
         * @name oauth:service:me:[oauthServer]
         * @event
         */
        app.reqres.request('oauth:service:me:' + oauthService, {
            oauthService: oauthService
        }).then(function(oauthUser) {
            app.log.debug('user.me.then', oauthUser);
            dfd.resolve(oauthUser);
        }).fail(function(error) {
            dfd.reject(error);
        });

        return dfd.promise;
    };

    /**
     * Registers a new user
     * @param  {Object} args
     * @param  {Object} args.oauthService Name of the oauth service ('silkroad', 'facebook', 'google', ...)
     * @param  {Object} args.email For silkroad-oauthServer-based users
     * @param  {Object} args.username For silkroad-oauthServer-based users
     * @param  {Object} args.firstName For silkroad-oauthServer-based users
     * @param  {Object} args.lastName For silkroad-oauthServer-based users
     * @param  {Object} args.password For silkroad-oauthServer-based users
     *
     * @return {Deferred}
     */
    user.register = function(args) {
        validate.isValue(args.oauthService, 'missing oauthService params');
        var dfd = q.defer();

        /**
         * Requests a handler for register in a specific oauthServer
         * @param  {Object} args
         * @param  {Object} args.oauthService Name of the oauth service ('silkroad', 'facebook', 'google', ...)
         * @return {Deferred}
         * @name oauth:service:register:[oauthServer]
         * @event
         */
        app.reqres.request('oauth:service:register:' + args.oauthService, args)
        .then(function(oauthUser) {
            return user.registerIAM(oauthUser);
        })
        .then(function(data) {
            app.log.info('user.register.success', data);
            dfd.resolve(data);
            return data;
        })
        .fail(function(error) {
            app.log.error('user.register.error', error);
            dfd.reject(error);
        });

        return dfd.promise;
    };

    /**
     * Registers an oauthUser in IAM
     * @param  {Object} oauthUser
     * @param  {Object} oauthUser.oauthId Id of the oauth user
     * @param  {Object} oauthUser.oauthService Name of the oauth service ('silkroad', 'facebook', 'google', ...)
     * @param  {Object} oauthUser.email For silkroad-oauthServer-based users
     * @param  {Object} oauthUser.username For silkroad-oauthServer-based users
     * @param  {Object} oauthUser.firstName For silkroad-oauthServer-based users
     * @param  {Object} oauthUser.lastName For silkroad-oauthServer-based users
     * @param  {Object} oauthUser.password For silkroad-oauthServer-based users
     * @return {Deferred}
     */
    user.registerIAM = function(oauthUser) {
        var oauthId = oauthUser.oauthId;
        var oauthService = oauthUser.oauthService;
        app.log.debug('user.registerIAM', oauthUser);
        oauthUser.scopes = app.common.get('claimScopesRegister');
        return iam.user().create(_.omit(oauthUser, ['oauthId', 'oauthService'])).then(function(id) {
            return iam.user(id).addIdentity({
                oauthService: oauthService,
                oauthId: oauthId
            });
        }).fail(function(error) {
            app.log.error('user.registerIAM.error', error);
            if (error.httpStatus === user.statusCode.USER_EXIST) {
                app.log.warn('user:register:exist');
                app.vent.trigger('user:register:exist');
            }
            var dfd = q.defer();
            dfd.reject(error);
            return dfd.promise;
        });
    };

    /**
     * Removes user
     * @return {Deferred}
     */
    user.remove = function(args) {
        args = args || {};
        args.oauthService = session.get('oauthService') || app.common.get('oauthService');
        return app.reqres.request('oauth:service:remove:' + args.oauthService).then(function() {
            return iam.user(session.get('user').id).delete();
        });
    };

    // Exposes module
    app.user = user;

    return user;

});</code></pre>
        </article>
    </section>





        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Fri Apr 04 2014 18:45:54 GMT+0200 (CEST)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>